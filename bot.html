<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Planning Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href = "cssfile/bot.css" rel = "stylesheet">
    <link rel="icon" href="images/bb04.png" type="image/x-icon" sizes="128x128">
</head>
<body>
    <div class="navb d-flex flex-column p-4 pt-2 fixed-top">
        <div class="d-flex align-items-center">
            <h1 class="m-3">Chatbot</h1>
        </div>
    </div>

    <div class = container>
        <div class="chat-container">
            <div class="chat-box" id="chat-box"></div>
            <div class="input-container">
                <input type="text" id="user-input" placeholder="Type your message...">
                <button onclick="sendMessage()"><svg id = "send" xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="currentColor" class="bi bi-arrow-up-circle-fill" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0m-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707z"/>
                  </svg></button>
            </div>
        </div>
    </div>
</div>

<footer>
    <ul class="nav justify-content-center gap-4">
        <li class="nav-item"><a href="allexpenses.html" class="nav-link px-2 text-body-secondary"><img src="./images/card-checklist.svg" height="28px"></a></li>
        <li class="nav-item"><a href="bot.html" class="nav-link px-2 text-body-secondary bot"><svg id = "bot" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-robot" viewBox="0 0 16 16">
            <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5M3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.6 26.6 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.93.93 0 0 1-.765.935c-.845.147-2.34.346-4.235.346s-3.39-.2-4.235-.346A.93.93 0 0 1 3 9.219zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a25 25 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25 25 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.7a.25.25 0 0 0-.182-.135"/>
            <path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2zM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.5 4h5A3.5 3.5 0 0 1 14 7.5"/>
          </svg></a></li>
        <li class="nav-item"><a href="./mainpage.html" class="nav-link px-2 text-body-secondary"><img src="./images/house.svg" height="28px"></a></li>
        <li class="nav-item"><a href="track.html" class="nav-link px-2 text-body-secondary"><img src="./images/currency-dollar.svg" height="28px"></a></li>
        <li class="nav-item"><a href="settings.html" class="nav-link px-2 text-body-secondary"><img src="./images/person.svg" height="28px"></a></li>
    </ul>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        loadChatHistory();
    });

    async function sendMessage() {
        let userMsg = document.getElementById('user-input').value;
        document.getElementById('user-input').value = '';

        // Append user message to chat box
        appendMessage('user-msg', userMsg);
        saveMessage('user-msg', userMsg);

        // Fetch bot response from OpenAI API
        let botMsg = await getBotResponse(userMsg);
        appendMessage('bot-msg', botMsg);
        saveMessage('bot-msg', botMsg);
    }

    function appendMessage(type, message) {
        let chatBox = document.getElementById('chat-box');
        let msgElement = document.createElement('div');
        msgElement.classList.add(type);
        msgElement.innerText = message;
        chatBox.appendChild(msgElement);

        // Scroll to bottom of chat box
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function saveMessage(type, message) {
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        chatHistory.push({ type, message });
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    }

    function loadChatHistory() {
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        chatHistory.forEach(chat => {
            appendMessage(chat.type, chat.message);
        });
    }

    async function getBotResponse(userMsg) {
        const apiKey = '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';
        const url = 'https://api.openai.com/v1/chat/completions';
        const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        const messages = chatHistory.map(chat => ({ role: chat.type === 'user-msg' ? 'user' : 'system', content: chat.message }));
        messages.push({ role: "user", content: userMsg });

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: "gpt-4",
                messages: messages,
                max_tokens: 150
            })
        });

        const data = await response.json();
        return data.choices[0].message.content.trim();
    }
</script>

</body>
</html>